# Документация для разработчиков и операционной команды

## Введение
Данный документ описывает инструкции по развертыванию, управлению и эксплуатации системы с использованием Docker Swarm. Включены основные шаги по настройке окружения, развертыванию микросервисов и мониторингу состояния системы.

---

## 1. Предварительные требования

### Для разработки:
- Установленный Docker версии 20.10 или выше.
- Установленный Docker Compose версии 1.29 или выше.
- Доступ к исходному коду микросервисов и файлу `docker-compose.yml`.

### Для эксплуатации:
- Минимум 3 узла с операционной системой Linux (рекомендуется Ubuntu 20.04 или выше). Это минимальное количество узлов необходимо для обеспечения отказоустойчивости. Три узла позволяют сохранить работу кластера даже при выходе из строя одного из них, что важно для высокодоступных систем.
- Установленный Docker Engine на каждом узле.
- Настроенная сеть с доступом между узлами на портах 2377, 7946 и 4789. Эти порты используются Docker Swarm для координации кластера:
  - **2377**: для управления кластером и добавления новых узлов.
  - **7946**: для взаимодействия между демонами Docker (например, обмена метаданными).
  - **4789**: для передачи данных через сеть OverLay. Это обеспечивает маршрутизацию и связь между сервисами.

---

## 2. Развертывание системы

### 2.1 Инициализация Docker Swarm
1. На главном узле выполните команду для инициализации Docker Swarm:
   ```bash
   docker swarm init --advertise-addr <IP-адрес главного узла>
   ```
2. Docker выдаст команду для подключения других узлов к кластеру. Например:
   ```bash
   docker swarm join --token <TOKEN> <IP-адрес главного узла>:2377
   ```
3. Выполните эту команду на всех рабочих узлах.

### 2.2 Проверка состояния кластера
- На главном узле выполните:
  ```bash
  docker node ls
  ```
  Убедитесь, что все узлы отображаются как "Active".

### 2.3 Развертывание стека
1. Подготовьте файл `docker-compose.yml`, описывающий сервисы и их конфигурацию.
2. Для развертывания выполните:
   ```bash
   docker stack deploy -c docker-compose.yml my-stack
   ```
   Здесь `my-stack` — это имя стека.

### 2.4 Проверка развертывания
- Проверьте состояние сервисов:
  ```bash
  docker stack services my-stack
  ```
- Проверьте логи:
  ```bash
  docker service logs my-stack_<имя-сервиса>
  ```

---

## 3. Управление системой

### 3.1 Остановка стека
Для остановки всех сервисов в стеке выполните:
```bash
docker stack rm my-stack
```

### 3.2 Масштабирование сервиса
Чтобы изменить количество реплик:
```bash
docker service scale my-stack_<имя-сервиса>=<число>
```
Пример:
```bash
docker service scale my-stack_web=5
```

### 3.3 Обновление сервиса
1. Обновите `docker-compose.yml`, если требуется изменить конфигурацию.
2. Перезапустите стек:
   ```bash
   docker stack deploy -c docker-compose.yml my-stack
   ```

### 3.4 Проверка состояния узлов
- Список узлов:
  ```bash
  docker node ls
  ```
- Информация о конкретном узле:
  ```bash
  docker node inspect <node-id>
  ```

---

## 4. Мониторинг и диагностика

### 4.1 Проверка логов
- Логи всего стека:
  ```bash
  docker service logs my-stack
  ```
- Логи конкретного сервиса:
  ```bash
  docker service logs my-stack_<имя-сервиса>
  ```

### 4.2 Мониторинг нагрузки
Используйте команды для проверки загрузки сервисов и узлов:
```bash
docker stats
```
Или установите дополнительные инструменты, такие как Prometheus и Grafana, для более детального мониторинга.

---

## 5. Особенности работы без подключения к интернету
1. Скачайте все необходимые образы заранее:
   ```bash
   docker pull <имя-образа>
   docker save -o <файл.tar> <имя-образа>
   ```
2. Перенесите образы на узлы без интернета и загрузите их:
   ```bash
   docker load -i <файл.tar>
   ```
3. Убедитесь, что файл `docker-compose.yml` не требует внешних репозиториев.

---

## 6. Частые проблемы и их решение

### Проблема: Сервис не запускается
1. Проверьте состояние сервиса:
   ```bash
   docker service ps my-stack_<имя-сервиса>
   ```
2. Проверьте логи:
   ```bash
   docker service logs my-stack_<имя-сервиса>
   ```
3. Убедитесь, что все зависимости сервиса работают (например, базы данных).

### Проблема: Узел потерял соединение с кластером
1. Убедитесь, что порты 2377, 7946, 4789 открыты.
2. Переподключите узел:
   ```bash
   docker swarm join --token <TOKEN> <IP-адрес главного узла>:2377
   ```

---

## 7. Документация для разработчиков

### Swagger для микросервисов
Каждый микросервис имеет собственный интерфейс Swagger для изучения и тестирования API. Доступ осуществляется через следующие URL:

- **Room Service**: [http://localhost:8090/swagger-ui/index.html#/](http://localhost:8090/swagger-ui/index.html#/)
- **Booking Service**: [http://localhost:8091/swagger-ui/index.html#/](http://localhost:8091/swagger-ui/index.html#/)
- **Customer Service**: [http://localhost:8092/swagger-ui/index.html#/](http://localhost:8092/swagger-ui/index.html#/)
- **Notification Service**: [http://localhost:8093/swagger-ui/index.html#/](http://localhost:8093/swagger-ui/index.html#/)

### Инструкции по использованию Swagger:
1. Перейдите по URL для интересующего микросервиса.
2. Ознакомьтесь с доступными эндпоинтами, их параметрами и описаниями.
3. Используйте функцию "Try it out" для тестирования запросов и получения ответов.

---

## 8. Заключение
Эта документация охватывает основные этапы работы с Docker Swarm: от инициализации до мониторинга и устранения неполадок. Разделы для разработчиков и операционной команды помогают наладить совместную работу и обеспечивают понимание системы для всех участников процесса. Для успешного управления системой рекомендуется внедрить процессы регулярного мониторинга и резервного копирования конфигураций.

